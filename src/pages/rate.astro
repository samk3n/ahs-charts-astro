---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { supabaseFromAstro } from "@/lib/supabaseServer";
import RateChartIsland from "@/components/RateChartIsland.tsx";
import { Image } from "astro:assets";
import hero from "@/assets/hero2.webp"

const supabase = supabaseFromAstro(Astro);

// Require auth â€“ if no user, redirect to login (replace path with your auth route)
const { data: userRes } = await supabase.auth.getUser();
if (!userRes.user) {
    return Astro.redirect("/auth/login");
}

// Load seasons (ordered)
const { data: seasons } = await supabase
    .from("seasons")
    .select("id,title,order_index")
    .eq("is_active", true)
    .order("order_index");

// Load user's existing ratings
const { data: myRatings } = await supabase
    .from("ratings")
    .select("season_id,rating")
    .eq("user_id", userRes.user.id);

const initial = Object.fromEntries(
    (myRatings ?? []).map((r) => [r.season_id, r.rating]),
);

// Email verification status
const emailVerified = !!userRes.user.email_confirmed_at;
---

<BaseLayout
    title="Rate AHS - Rate every season right now"
    description="Rate every season of American Horror Story."
>
    <section
        class="relative h-96 flex flex-col items-center justify-center overflow-hidden py-24 text-center text-white"
    >
        <Image
            src={hero}
            alt=""
            class="absolute inset-0 h-full w-full object-cover object-center brightness-90 md:brightness-70"
            loading="lazy"
        />
        
        <div class="relative z-10 max-w-3xl px-4">
            <h1 class="mb-1 text-3xl tracking-wide font-display">
                An Autopsy of Horrors
            </h1>
            <p class="max-w-[720px] text-muted">
                Examine the evidence. Dissect each season's madness and assign a score based on your morbid findings.
            </p>
        </div>
    </section>

    <section class="container py-6">
        <RateChartIsland
            client:load
            seasons={seasons ?? []}
            initialRatings={initial}
            emailVerified={emailVerified}
        />
    </section>
</BaseLayout>
