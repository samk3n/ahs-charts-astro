---
import BaseLayout from "@/layouts/BaseLayout.astro";
import SVGBarChart from "@/components/SVGBarChart.tsx";
import { supabaseFromAstro } from "@/lib/supabaseServer";
import CTASection from "@/components/CTASection.astro";
import { Image } from "astro:assets";
import hero from "@/assets/hero3.webp"

const supabase = supabaseFromAstro(Astro);

// Join seasons with avg_ratings to get ordered labels + averages (live)
const { data, error } = await supabase
    .from("seasons")
    .select("id,title,order_index,avg:avg_ratings(avg_rating,count_users)")
    .eq("is_active", true)
    .order("order_index");

const labels = data?.map((s) => s.title) ?? [];
const values = data?.map((s) => Number(s.avg?.[0]?.avg_rating ?? 0)) ?? [];
const totalRaters = data?.[0]?.avg?.[0]?.count_users ?? 0; // rough indicator; counts vary per season
---

<BaseLayout
    title="Rate AHS - Global Averages"
    description="See the average community rating for each season of American Horror Story."
>
    <section
        class="relative h-96 flex flex-col items-center justify-center overflow-hidden py-24 text-center text-white"
    >
        <Image
            src={hero}
            alt=""
            class="absolute inset-0 h-full w-full object-cover object-center brightness-60 md:brightness-50"
            loading="lazy"
        />
        <div class="relative z-10 max-w-3xl px-4">
            <h1 class="mb-1 text-3xl tracking-wide font-display">
                The Morbid Consensus
            </h1>
            <p class="max-w-[720px] text-muted">
                A live statistical analysis of the madness. Witness the
                collective verdict on which horrors truly cut the deepest.
            </p>
        </div>
    </section>

    <section class="mx-auto max-w-3xl py-6">
        {
            error && (
                <div class="mb-4 rounded-lg border border-border bg-panel p-3 text-sm text-red-500">
                    Failed to load stats: {error.message}
                </div>
            )
        }

        <div class="rounded-xl border border-border bg-panel p-4">
            <div class="mb-3 flex items-center justify-between">
                <h2 class="text-sm font-semibold tracking-wide text-muted">
                    Average rating per season
                </h2>
                <div class="text-sm text-muted">
                    {!error && `Participants: ${totalRaters.toLocaleString()}`}
                </div>
            </div>

            <SVGBarChart labels={labels} values={values} />
        </div>
    </section>

    <section class="">
        <CTASection />
    </section>
</BaseLayout>
